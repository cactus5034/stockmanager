import sqlite3
import csv

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í•¨ìˆ˜
def init_db():
    conn = sqlite3.connect("inventory.db")
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS inventory (
            barcode TEXT PRIMARY KEY,
            qcode TEXT,
            description TEXT,
            stock INTEGER,
            location TEXT,
            equipment_group TEXT
        )
    """)
    conn.commit()
    conn.close()


import os
import sys

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í•¨ìˆ˜
def init_db():
    conn = sqlite3.connect("inventory.db")
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS inventory (
            barcode TEXT PRIMARY KEY,
            qcode TEXT,
            description TEXT,
            stock INTEGER,
            location TEXT,
            equipment_group TEXT
        )
    """)
    conn.commit()
    conn.close()

def connect_db():
    return sqlite3.connect("inventory.db")

# ì´ ìƒí’ˆ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
def get_total_product_count():
    conn = connect_db()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM inventory")  # ì œí’ˆ ê°œìˆ˜ ì¡°íšŒ
    total_products = cursor.fetchone()[0]
    conn.close()
    return total_products

# ìƒí’ˆ ì¶”ê°€ í•¨ìˆ˜
def add_product(barcode, qcode, description, stock, location, equipment_group):
    conn = sqlite3.connect("inventory.db")
    cur = conn.cursor()
    try:
        cur.execute("INSERT INTO inventory (barcode, qcode, description, stock, location, equipment_group) VALUES (?, ?, ?, ?, ?, ?)",
                (barcode, qcode, description, stock, location, equipment_group))
        conn.commit()
        conn.close()
        return True
    except sqlite3.IntegrityError:
        conn.close()
        return False

# ëª¨ë“  ìƒí’ˆ ê°€ì ¸ì˜¤ê¸°
def get_all_products():
    try:
        conn = connect_db()
        cursor = conn.cursor()
        cursor.execute("SELECT barcode, qcode, description, stock, location, equipment_group FROM inventory")
        products = cursor.fetchall()
        conn.close()
        return products
    except Exception as e:
        print(f"[ERROR] Failed to load products: {e}")
        return []  # â— ì—ëŸ¬ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜



def update_stock(barcode, amount):
    """âœ… ë°”ì½”ë“œë¡œ ì œí’ˆì„ ê²€ìƒ‰í•œ í›„ ì¬ê³ ë¥¼ ì—…ë°ì´íŠ¸"""
    conn = connect_db()
    cursor = conn.cursor()

    # âœ… 1. ë°”ì½”ë“œê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
    cursor.execute("SELECT stock FROM inventory WHERE barcode = ?", (barcode,))
    product = cursor.fetchone()

    if not product:  # âŒ ì œí’ˆì´ ì—†ìœ¼ë©´ False ë°˜í™˜
        conn.close()
        return False, None

    # âœ… 2. ê¸°ì¡´ ì¬ê³  ê°’ ê°€ì ¸ì˜¤ê¸° & ì—…ë°ì´íŠ¸
    try:
        current_stock = product[0]
        new_stock = max(0, current_stock + amount)  # ì¬ê³ ê°€ 0 ì´í•˜ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šë„ë¡ ì²˜ë¦¬

        cursor.execute("UPDATE inventory SET stock = ? WHERE barcode = ?", (new_stock, barcode))
        conn.commit()
        conn.close()
        return True, new_stock  # âœ… ì„±ê³µ ì‹œ True ë°˜í™˜

    except sqlite3.IntegrityError:
        conn.close()
        return False, current_stock  # ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ì¬ê³  ê·¸ëŒ€ë¡œ ë°˜í™˜



def get_stock_by_barcode(barcode):
    """âœ… ë°”ì½”ë“œë¡œ ì œí’ˆ ì •ë³´ ê²€ìƒ‰í•˜ì—¬ ì œí’ˆëª…ê³¼ ì¬ê³  ë°˜í™˜"""
    conn = connect_db()
    cursor = conn.cursor()
    cursor.execute("SELECT qcode, stock FROM inventory WHERE barcode = ?", (barcode,))
    product = cursor.fetchone()
    conn.close()

    if product:
        return product  # (qcode, stock) ë°˜í™˜
    return None  # ì œí’ˆì´ ì—†ìœ¼ë©´ None ë°˜í™˜



##########

import os


from PyQt5.QtWidgets import QMessageBox

import sqlite3

def search_product(search_text):
    """ğŸ“¦ ë°”ì½”ë“œ ë˜ëŠ” ì œí’ˆëª…ì— í¬í•¨ëœ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰í•˜ì—¬ ëª¨ë“  ì •ë³´ ë°˜í™˜"""
    try:
        conn = sqlite3.connect("inventory.db")
        cursor = conn.cursor()
        
        # âœ… inventory í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ ì²´í¬
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='inventory'")
        if not cursor.fetchone():
            print("âš ï¸ [WARNING] inventory í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.")
            return []

        # âœ… ì •ìƒ ì¿¼ë¦¬ ì‹¤í–‰
        query = """
        SELECT barcode, qcode, description, stock, location, equipment_group 
        FROM inventory 
        WHERE CAST(barcode AS TEXT) LIKE ? OR qcode LIKE ?
        """
        cursor.execute(query, (f"%{search_text}%", f"%{search_text}%"))
        results = cursor.fetchall()
        conn.close()
        return results

    except sqlite3.Error as e:
        print(f"âŒ [ERROR] SQL ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []  # ì—ëŸ¬ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜





def delete_product(barcode):
    """ğŸ—‘ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ íŠ¹ì • ì œí’ˆ ì‚­ì œ (ì˜¤ë¥˜ ë°œìƒ ì‹œ GUI ì•Œë¦¼ ê°€ëŠ¥)"""
    conn = sqlite3.connect("inventory.db")
    cursor = conn.cursor()

    try:
        query = "DELETE FROM inventory WHERE barcode = ?"
        cursor.execute(query, (barcode,))
        conn.commit()

        if cursor.rowcount == 0:
            print(f"âš ï¸ [WARNING] ë°”ì½”ë“œ {barcode}ì— í•´ë‹¹í•˜ëŠ” ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.")
            return False  # ì‚­ì œëœ ë°ì´í„° ì—†ìŒ
        
        print(f"âœ… [SUCCESS] ë°”ì½”ë“œ {barcode} ì œí’ˆ ì‚­ì œ ì™„ë£Œ.")
        return True  # ì •ìƒ ì‚­ì œ ì™„ë£Œ

    except sqlite3.OperationalError as e:
        print(f"âŒ [ERROR] ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return False  # ì˜¤ë¥˜ ë°œìƒ

    finally:
        conn.close()
    
    
    
    

def modify_product(barcode, new_qcode, new_description, new_stock, new_location, new_equipment):
    """âœï¸ ì œí’ˆ ì •ë³´ ìˆ˜ì •"""
    conn = sqlite3.connect("inventory.db")
    cursor = conn.cursor()

    query = """
    UPDATE inventory
    SET qcode = ?, description =?,  stock = ?, location = ?, equipment_group = ?
    WHERE barcode = ?
    """
    cursor.execute(query, (new_qcode, new_description, new_stock, new_location, new_equipment, barcode))
    conn.commit()

    conn.close()




######


        
def export_inventory_to_csv(filename):
    conn = connect_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute("SELECT * FROM inventory")
        products = cursor.fetchall()

        # CSV íŒŒì¼ ì‘ì„±
        with open(filename, 'w', newline='') as file:
            writer = csv.writer(file)
            writer.writerow(["Barcode", "Qcode", "Description", "Stock", "Location", "EQP Group"])  # í—¤ë” ì¶”ê°€
            writer.writerows(products)  # ë°ì´í„° ì¶”ê°€
        
        conn.close()
        return True  # ì„±ê³µ ì‹œ True ë°˜í™˜

    except Exception as e:
        print("Error exporting CSV:", e)
        conn.close()
        return False  # ì‹¤íŒ¨ ì‹œ False ë°˜í™˜

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤í–‰
init_db()
