import sys
import csv
import database  # ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QLabel, QPushButton, QComboBox,QHeaderView,
    QVBoxLayout, QHBoxLayout, QFrame, QTableWidget, QTableWidgetItem, QSizePolicy,
    QLineEdit, QStackedWidget, QFileDialog, QMessageBox, QAbstractItemView, QSpinBox
)
from PyQt5.QtGui import QFont
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QIntValidator  # âœ… PyQt5.QtWidgetsê°€ ì•„ë‹ˆë¼ PyQt5.QtGuiì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨


class InventoryApp(QMainWindow):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("Stock Manager")
        self.setGeometry(100, 100, 1200, 800)

        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)

        self.main_layout = QVBoxLayout(self.central_widget)

        # === ìƒë‹¨ íƒ€ì´í‹€ ===
        self.title_label = QLabel("Stock Manager", self)
        self.title_label.setFont(QFont("SamsungOne", 24, QFont.Bold))
        self.title_label.setAlignment(Qt.AlignCenter)
        self.main_layout.addWidget(self.title_label)

        # === ë©”ì¸ ì»¨í…ì¸  (ì‚¬ì´ë“œë°” + ì¤‘ì•™) ===
        self.content_layout = QHBoxLayout()
        self.main_layout.addLayout(self.content_layout)

        # === ì‚¬ì´ë“œë°” (ë„¤ë¹„ê²Œì´ì…˜) ===
        self.sidebar = QFrame()
        self.sidebar.setFixedWidth(600)
        self.sidebar.setStyleSheet("background-color: #f4f4f4; border-right: 2px solid #ccc;")
        self.sidebar_layout = QVBoxLayout(self.sidebar)

        self.add_sidebar_button("Dashboard / Inventory", 0)
        self.add_sidebar_button("Stock Update", 1)
        self.add_sidebar_button("Product Registration", 2)
        self.add_sidebar_button("Info Modify / Delete", 3)
        self.add_sidebar_button("Export CSV", 4)

        self.content_layout.addWidget(self.sidebar)

        # === ì¤‘ì•™ ì»¨í…ì¸  (í˜ì´ì§€ ì „í™˜) ===
        self.pages = QStackedWidget()
        self.content_layout.addWidget(self.pages)
        self.content_layout.setStretch(1, 3)
        
        
        #í˜ì´ì§€ ì„ ì–¸
        self.dashboard_inventory_page = QWidget()
        self.stock_update_page = QWidget()
        self.registration_page = QWidget()
        self.modify_delete_page = QWidget()
        self.export_page = QWidget()

        self.pages.addWidget(self.dashboard_inventory_page)
        self.pages.addWidget(self.stock_update_page)
        self.pages.addWidget(self.registration_page)
        self.pages.addWidget(self.modify_delete_page)
        self.pages.addWidget(self.export_page)

        self.setup_dashboard_inventory()
        self.setup_stock_update()
        self.setup_product_registration()
        self.setup_modify_delete()
        self.setup_export_page()

        # âœ… í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì‹œ DBì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        self.load_inventory_data()

    def add_sidebar_button(self, name, index):
        button = QPushButton(name)
        button.setFont(QFont("SamsungOne", 12))
        button.setStyleSheet("QPushButton {background-color: #007BFF; color: white; border-radius: 5px; padding: 10px;} QPushButton:hover {background-color: #0056b3;}")
        
        # âœ… ë²„íŠ¼ ë™ì‘ ì •ì˜ (í˜ì´ì§€ ì´ë™ + ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨)
        def on_click():
            if name == "Dashboard / Inventory":
                self.load_inventory_data()  # ğŸ”¥ ìµœì‹  ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ê°±ì‹ 
            self.pages.setCurrentIndex(index)

        button.clicked.connect(on_click)
        self.sidebar_layout.addWidget(button)
#########################################

    def setup_dashboard_inventory(self):
        """âœ… Dashboard UI ì„¤ì • (ê²€ìƒ‰ ì˜µì…˜ ì¶”ê°€)"""
        layout = QVBoxLayout(self.dashboard_inventory_page)

        # ğŸ”¢ ì´ ì œí’ˆ ê°œìˆ˜ í‘œì‹œ
        self.total_products_label = QLabel("Total Products: 0")
        self.total_products_label.setFont(QFont("SamsungOne", 16))
        layout.addWidget(self.total_products_label)

        # ğŸ” ê²€ìƒ‰ì°½ + ë²„íŠ¼ + ì˜µì…˜ ì¶”ê°€
        search_layout = QHBoxLayout()

        self.search_mode = QComboBox()  # âœ… ê²€ìƒ‰ ë°©ì‹ ì„ íƒ (ë°”ì½”ë“œ / ì œí’ˆëª…)
        self.search_mode.setFixedHeight(40)
        self.search_mode.addItems(["Search by Barcode", "Search by Product Name"])

        self.search_input = QLineEdit()
        self.search_input.setFixedHeight(40)
        self.search_input.setPlaceholderText("Enter search text")

        self.search_button = QPushButton("ğŸ” Search")  # âœ… ê²€ìƒ‰ ë²„íŠ¼ ì¶”ê°€
        self.search_button.setFixedHeight(40)
        self.search_button.clicked.connect(self.search_inventory)  # âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
        self.search_input.returnPressed.connect(self.search_inventory)  # âœ… Enter í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰

        search_layout.addWidget(self.search_mode)
        search_layout.addWidget(self.search_input)
        search_layout.addWidget(self.search_button)
        layout.addLayout(search_layout)

        # ğŸ“ ì¬ê³  ì¡°íšŒ í…Œì´ë¸” ì¶”ê°€
        self.table = QTableWidget(0, 5)
        self.table.setHorizontalHeaderLabels(["Barcode", "Product Name", "Stock", "Location", "Equipment Group"])
        layout.addWidget(self.table)
        
        # âœ… ğŸ”¥ í…Œì´ë¸” ì—´ í¬ê¸° ìë™ ì¡°ì •
        header = self.table.horizontalHeader()
        header.setSectionResizeMode(QHeaderView.Stretch)  # ğŸ”¥ ì—´ì´ í…Œì´ë¸” ì „ì²´ ë„ˆë¹„ë¥¼ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì •

        self.dashboard_inventory_page.setLayout(layout)

#########################################
        
        
    def search_inventory(self):
        """âœ… ì„ íƒëœ ê²€ìƒ‰ ë°©ì‹ (ë°”ì½”ë“œ or ì œí’ˆëª…)ì— ë”°ë¼ ì •í™•í•˜ê²Œ ê²€ìƒ‰"""
        search_text = self.search_input.text().strip().lower()  # ğŸ” ê²€ìƒ‰ì–´ (ì†Œë¬¸ìë¡œ ë³€í™˜)
        search_mode = self.search_mode.currentText()  # âœ… ì„ íƒëœ ê²€ìƒ‰ ë°©ì‹

        print(f"ğŸ” ê²€ìƒ‰ ì‹¤í–‰ - ê²€ìƒ‰ì–´: {search_text}, ê²€ìƒ‰ ë°©ì‹: {search_mode}")

        self.table.setRowCount(0)  # âœ… ğŸ”¥ ê²€ìƒ‰ ì‹¤í–‰ ì „ì— í…Œì´ë¸” ì´ˆê¸°í™”

        products = database.get_all_products()  # ğŸ›  DBì—ì„œ ëª¨ë“  ì œí’ˆ ê°€ì ¸ì˜¤ê¸°
        matched_products = []  # âœ… ê²€ìƒ‰ ê²°ê³¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
        
        # ğŸ”¥ ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡ ë‹¤ì‹œ í‘œì‹œ
        if not search_text:
            self.load_inventory_data()
            return

        for product in products:
            barcode, name, stock, location, equipment_group = product

            # ğŸ” ë¹„êµë¥¼ ìœ„í•´ ì†Œë¬¸ìë¡œ ë³€í™˜
            barcode_lower = barcode.lower()
            name_lower = name.lower()

            # ğŸ” ê²€ìƒ‰ ëª¨ë“œì— ë”°ë¼ í•„í„°ë§ ë°©ì‹ ë³€ê²½ (ì •í™•í•œ ë§¤ì¹­)
            if search_mode == "Search by Barcode" and search_text not in barcode_lower:
                continue  # ë°”ì½”ë“œ ê²€ìƒ‰ì¸ë° ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ê±´ë„ˆë›°ê¸°
            if search_mode == "Search by Product Name" and search_text not in name_lower:
                continue  # ì œí’ˆëª… ê²€ìƒ‰ì¸ë° ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ê±´ë„ˆë›°ê¸°

            # âœ… ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            matched_products.append((barcode, name, stock, location, equipment_group))

        # âœ… ê²€ìƒ‰ ê²°ê³¼ë¥¼ í…Œì´ë¸”ì— ì¶”ê°€
        if matched_products:
            for barcode, name, stock, location, equipment_group in matched_products:
                row_count = self.table.rowCount()
                self.table.insertRow(row_count)
                self.table.setItem(row_count, 0, QTableWidgetItem(barcode))
                self.table.setItem(row_count, 1, QTableWidgetItem(name))
                self.table.setItem(row_count, 2, QTableWidgetItem(str(stock)))
                self.table.setItem(row_count, 3, QTableWidgetItem(location))
                self.table.setItem(row_count, 4, QTableWidgetItem(equipment_group))
        else:
            # âœ… ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ ì¶œë ¥
            self.table.setRowCount(1)
            self.table.setItem(0, 0, QTableWidgetItem("No results found"))
            self.table.setSpan(0, 0, 1, 5)  # âœ… ì „ì²´ ì—´ì„ í•˜ë‚˜ë¡œ ë³‘í•©í•˜ì—¬ ë©”ì‹œì§€ í‘œì‹œ
            self.table.item(0, 0).setTextAlignment(Qt.AlignCenter)

       
#########################################


    def setup_stock_update(self):
        """âœ… Stock Update í™”ë©´ - ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ì¶”ê°€"""
        wrapper_layout = QVBoxLayout(self.stock_update_page)
        wrapper_layout.setAlignment(Qt.AlignCenter)  # âœ… í˜ì´ì§€ ì „ì²´ë¥¼ ì¤‘ì•™ ì •ë ¬
        
         # 2ï¸âƒ£ ë‚´ë¶€ ìš”ì†Œë¥¼ ê°ìŒ€ ìƒˆë¡œìš´ QWidgetì„ ìƒì„± (ë¶€ëª¨ ì˜í–¥ ìµœì†Œí™”)
        central_widget = QWidget()
        central_layout = QVBoxLayout(central_widget)
        central_layout.setAlignment(Qt.AlignCenter)  # ğŸ”¥ ë‚´ë¶€ ìš”ì†Œë„ ì¤‘ì•™ ì •ë ¬ ê°•ì œ
               
        self.stock_input = QLineEdit()
        self.stock_input.setPlaceholderText("Enter barcode")
        self.stock_input.setFixedHeight(40)  # âœ… ì…ë ¥ í•„ë“œ ë†’ì´ ì¡°ì •
        self.stock_input.setFixedWidth(650)
    
        # âœ… ë³€ê²½í•  ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ì¶”ê°€
        self.quantity_input = QLineEdit()
        self.quantity_input.setPlaceholderText("Enter quantity")
        self.quantity_input.setValidator(QIntValidator(1, 9999))  # ğŸ”¥ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥
        self.quantity_input.setFixedHeight(40)  # âœ… ë†’ì´ ì¡°ì •
        self.quantity_input.setFixedWidth(650)

        self.product_name_label = QLabel("Product name: -")
        self.product_name_label.setFixedHeight(40)
        self.product_name_label.setFixedWidth(650)  
        self.current_stock_label = QLabel("Current stock(í˜„ ì¬ê³ ): -")
        self.current_stock_label.setFixedHeight(40) 
        self.current_stock_label.setFixedWidth(650) 


        self.increase_button = QPushButton("+ ì…ê³ ")
        self.decrease_button = QPushButton("- ì¶œê³ ")
        self.increase_button.setFixedHeight(40)
        self.increase_button.setFixedWidth(320)
        self.decrease_button.setFixedHeight(40)
        self.decrease_button.setFixedWidth(320)
        
        button_layout = QHBoxLayout()
        button_layout.setAlignment(Qt.AlignCenter)  # ë²„íŠ¼ì„ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬
        button_layout.addWidget(self.increase_button)
        button_layout.addWidget(self.decrease_button)

        # 5ï¸âƒ£ âœ… ëª¨ë“  ìš”ì†Œë¥¼ ë©”ì¸ ë ˆì´ì•„ì›ƒì— ì¶”ê°€
        central_layout.addWidget(self.stock_input, alignment=Qt.AlignCenter)
        central_layout.addWidget(self.quantity_input, alignment=Qt.AlignCenter)
        central_layout.addWidget(self.product_name_label, alignment=Qt.AlignCenter)
        central_layout.addWidget(self.current_stock_label, alignment=Qt.AlignCenter)
        central_layout.addLayout(button_layout)  # ë²„íŠ¼ ë ˆì´ì•„ì›ƒ ì¶”ê°€

        # 6ï¸âƒ£ `central_widget`ì„ `wrapper_layout`ì— ì¶”ê°€ (ë¶€ëª¨ ë ˆì´ì•„ì›ƒ ì˜í–¥ ì°¨ë‹¨)
        wrapper_layout.addStretch(1)  # ğŸ”¥ ìœ„ìª½ ê³µê°„ í™•ë³´
        wrapper_layout.addWidget(central_widget, alignment=Qt.AlignCenter)  # ğŸ”¥ ì™„ì „ ì¤‘ì•™ ì •ë ¬
        wrapper_layout.addStretch(1)  # ğŸ”¥ ì•„ë˜ìª½ ê³µê°„ í™•ë³´
        

        # âœ… ë²„íŠ¼ í´ë¦­ ì‹œ `action`ì„ ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •
        self.increase_button.clicked.connect(lambda: self.update_stock("inbound"))
        self.decrease_button.clicked.connect(lambda: self.update_stock("outbound"))

        self.stock_input.returnPressed.connect(self.search_stock)  

        
#########################################        


    def setup_product_registration(self):
        ##layout = QVBoxLayout(self.registration_page)
        
        # 1ï¸âƒ£ stock_update_pageì²˜ëŸ¼ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ë˜í¼ ë ˆì´ì•„ì›ƒ ìƒì„±
        wrapper_layout = QVBoxLayout(self.registration_page)
        wrapper_layout.setAlignment(Qt.AlignCenter)  # ğŸ”¥ í˜ì´ì§€ ì „ì²´ ì¤‘ì•™ ì •ë ¬ ê°•ì œ

        # 2ï¸âƒ£ ë‚´ë¶€ ìš”ì†Œë¥¼ ê°ìŒ€ QWidget ìƒì„± (ë¶€ëª¨ ì˜í–¥ ìµœì†Œí™”)
        central_widget = QWidget()
        central_layout = QVBoxLayout(central_widget)
        central_layout.setAlignment(Qt.AlignCenter)  # ğŸ”¥ ë‚´ë¶€ ìš”ì†Œë„ ì¤‘ì•™ ì •ë ¬ ê°•ì œ

        
        
        self.barcode_input = QLineEdit()
        self.product_name_input = QLineEdit()
        self.product_stock_input = QLineEdit()
        self.location_input = QLineEdit()
        self.equipment_group_input = QComboBox()
        
        # 5ï¸âƒ£ âœ… ì˜µì…˜ ì¶”ê°€ (ì´ ë¦¬ìŠ¤íŠ¸ë§Œ ì„ íƒ ê°€ëŠ¥)
        equipment_options = [
            "LAM(ALD)", "LAM(HDP)", "IPS(ALD)", "IPS(GEMINI, ASI)",
            "IPS(MP)", "TEL(TOSZ)", "SEMES(TOSZ)"
        ]
        self.equipment_group_input.addItems(equipment_options)

        self.barcode_input.setPlaceholderText("Barcode")
        self.barcode_input.setFixedHeight(40)
        self.barcode_input.setFixedWidth(650)
        self.product_name_input.setPlaceholderText("Product Name")
        self.product_name_input.setFixedHeight(40)
        self.product_name_input.setFixedWidth(650)
        self.product_stock_input.setPlaceholderText("Stock")
        self.product_stock_input.setFixedHeight(40)
        self.product_stock_input.setFixedWidth(650)
        self.location_input.setPlaceholderText("Location")
        self.location_input.setFixedHeight(40)
        self.location_input.setFixedWidth(650)
        self.equipment_group_input.setPlaceholderText("Equipment Group")
        self.equipment_group_input.setFixedHeight(40)
        self.equipment_group_input.setFixedWidth(650)

        self.register_button = QPushButton("Register Product")
        self.register_button.setFixedHeight(40)
        self.register_button.clicked.connect(self.register_product)

        central_layout.addWidget(self.barcode_input)
        central_layout.addWidget(self.product_name_input)
        central_layout.addWidget(self.product_stock_input)
        central_layout.addWidget(self.location_input)
        central_layout.addWidget(self.equipment_group_input)
        central_layout.addWidget(self.register_button)
        
        # 5ï¸âƒ£ `central_widget`ì„ `wrapper_layout`ì— ì¶”ê°€ (ë¶€ëª¨ ì˜í–¥ ì°¨ë‹¨)
        wrapper_layout.addStretch(1)  # ğŸ”¥ ìœ„ìª½ ê³µê°„ í™•ë³´
        wrapper_layout.addWidget(central_widget, alignment=Qt.AlignCenter)  # ğŸ”¥ ì™„ì „ ì¤‘ì•™ ì •ë ¬
        wrapper_layout.addStretch(1)  # ğŸ”¥ ì•„ë˜ìª½ ê³µê°„ í™•ë³´

#########################################

    def setup_modify_delete(self):
        """ğŸ” ìˆ˜ì • ë° ì‚­ì œ í˜ì´ì§€ UI êµ¬ì„±"""
        
        wrapper_layout = QVBoxLayout(self.modify_delete_page)
        wrapper_layout.setAlignment(Qt.AlignCenter)  # ğŸ”¥ í˜ì´ì§€ ì „ì²´ ì¤‘ì•™ ì •ë ¬ ê°•ì œ

        # 2ï¸âƒ£ ë‚´ë¶€ ìš”ì†Œë¥¼ ê°ìŒ€ QWidget ìƒì„± (ë¶€ëª¨ ì˜í–¥ ìµœì†Œí™”)
        central_widget = QWidget()
        central_layout = QVBoxLayout(central_widget)
        central_layout.setAlignment(Qt.AlignCenter)  # ğŸ”¥ ë‚´ë¶€ ìš”ì†Œë„ ì¤‘ì•™ ì •ë ¬ ê°•ì œ

        # ğŸ” ê²€ìƒ‰ ì…ë ¥ í•„ë“œ & ë²„íŠ¼
        self.search_input = QLineEdit(self)
        self.search_input.setPlaceholderText("Enter Barcode or Product Name")
        self.search_input.setFixedHeight(40)
        self.search_input.setFixedWidth(650)

        self.search_button = QPushButton("Search")
        self.search_button.setFixedHeight(40)
        self.search_button.setFixedWidth(650)
        self.search_button.clicked.connect(self.handle_search)

        search_layout = QHBoxLayout()
        search_layout.addWidget(self.search_input)
        search_layout.addWidget(self.search_button)

        # ğŸ”½ ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸”
        self.results_table = QTableWidget(0,5)
        self.results_table.setColumnCount(5)  
        self.results_table.setHorizontalHeaderLabels(["Barcode", "Product Name", "Stock", "Location", "Equipment Group"])
        self.results_table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.results_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.results_table.setSelectionMode(QAbstractItemView.SingleSelection)
        
        # âœ… ğŸ”¥ í…Œì´ë¸” ì—´ í¬ê¸° ìë™ ì¡°ì •
        header2 = self.results_table.horizontalHeader()
        header2.setSectionResizeMode(QHeaderView.Stretch)  # ğŸ”¥ ì—´ì´ í…Œì´ë¸” ì „ì²´ ë„ˆë¹„ë¥¼ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì •

        # âœï¸ ìˆ˜ì • & ğŸ—‘ ì‚­ì œ ë²„íŠ¼
        self.modify_button = QPushButton("Modify")
        self.modify_button.setFixedHeight(40)
        self.modify_button.setEnabled(False)
        self.modify_button.clicked.connect(self.handle_modify)

        self.delete_button = QPushButton("Delete")
        self.delete_button.setFixedHeight(40)
        self.delete_button.setEnabled(False)
        self.delete_button.clicked.connect(self.handle_delete)

        button_layout = QHBoxLayout()
        button_layout.addWidget(self.modify_button)
        button_layout.addWidget(self.delete_button)

        # ğŸ”— ê¸°ì¡´ ë©”ì¸ ë ˆì´ì•„ì›ƒì„ ë¨¼ì € ì •ë¦¬í•˜ê³  ì¶”ê°€
        central_layout.addLayout(search_layout)
        central_layout.addWidget(self.results_table)
        central_layout.addLayout(button_layout)

        # í…Œì´ë¸”ì—ì„œ í–‰ì´ ì„ íƒë  ë•Œ ë²„íŠ¼ í™œì„±í™”
        self.results_table.itemSelectionChanged.connect(self.toggle_buttons)

        # 5ï¸âƒ£ `central_widget`ì„ `wrapper_layout`ì— ì¶”ê°€ (ë¶€ëª¨ ì˜í–¥ ì°¨ë‹¨)
        wrapper_layout.addStretch(1)  # ğŸ”¥ ìœ„ìª½ ê³µê°„ í™•ë³´
        wrapper_layout.addWidget(central_widget, alignment=Qt.AlignCenter)  # ğŸ”¥ ì™„ì „ ì¤‘ì•™ ì •ë ¬
        wrapper_layout.addStretch(1)  # ğŸ”¥ ì•„ë˜ìª½ ê³µê°„ í™•ë³´


#########################################


    def setup_export_page(self):
        layout = QVBoxLayout(self.export_page)
        self.export_button = QPushButton("Export Inventory to CSV")
        self.export_button.setFixedHeight(50)
        self.export_button.clicked.connect(self.export_to_csv)
        layout.addWidget(self.export_button)
        
        
        
#########################################




    def register_product(self):
        barcode = self.barcode_input.text()
        name = self.product_name_input.text()
        stock = self.product_stock_input.text()
        location = self.location_input.text()
        equipment_group = self.equipment_group_input.currentText()

        if not (barcode and name and stock and location and equipment_group):
            return  

        database.add_product(barcode, name, int(stock), location, equipment_group)
        self.load_inventory_data()
        
        # âœ… ë“±ë¡ ì™„ë£Œ íŒì—… ì¶”ê°€
        QMessageBox.information(self, "ë“±ë¡ ì™„ë£Œ", "ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def search_stock(self):
        """âœ… ë°”ì½”ë“œë¡œ ì œí’ˆ ì •ë³´ ê²€ìƒ‰í•˜ì—¬ í™”ë©´ì— í‘œì‹œ"""
        barcode = self.stock_input.text().strip()

        if not barcode:
            self.product_name_label.setText("Product: -")
            self.current_stock_label.setText("Current Stock: -")
            return  

        product = database.get_stock_by_barcode(barcode)

        if product:
            name, stock = product
            self.product_name_label.setText(f"Product: {name}")
            self.current_stock_label.setText(f"Current Stock: {stock}")
        else:
            self.product_name_label.setText("Product: Not Found")
            self.current_stock_label.setText("Current Stock: -")

    
    
    def update_stock(self, action):
        """âœ… ì…ê³ /ì¶œê³  ì‹œ ì˜¤ë¥˜ ë°œìƒí•´ë„ GUIê°€ êº¼ì§€ì§€ ì•Šë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬ ì¶”ê°€"""
        try:
            barcode = self.stock_input.text().strip()
            quantity_text = self.quantity_input.text().strip()

            if not barcode:
                QMessageBox.warning(self, "ì…ë ¥ ì˜¤ë¥˜", "ë°”ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
                return  

            if not quantity_text.isdigit():  # ğŸ”¥ ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬
                QMessageBox.warning(self, "ì…ë ¥ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
                return  

            quantity = int(quantity_text)

            if action == "inbound":
                success, new_stock = database.update_stock(barcode, quantity)  # âœ… ì…ë ¥í•œ ìˆ˜ëŸ‰ë§Œí¼ ì¦ê°€
            elif action == "outbound":
                success, new_stock = database.update_stock(barcode, -quantity)  # âœ… ì…ë ¥í•œ ìˆ˜ëŸ‰ë§Œí¼ ê°ì†Œ
            else:
                QMessageBox.critical(self, "ì˜¤ë¥˜", "ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—… ìš”ì²­ì…ë‹ˆë‹¤.")
                return

            if success:
                self.load_inventory_data()  # âœ… ì „ì²´ ë°ì´í„° ê°±ì‹ 
                self.product_name_label.setText(f"Product: {database.get_stock_by_barcode(barcode)[0]}")
                self.current_stock_label.setText(f"Current Stock: {new_stock}")
                QMessageBox.information(self, "ì¬ê³  ì—…ë°ì´íŠ¸ ì™„ë£Œ", f"í˜„ì¬ ì¬ê³ : {new_stock}")
                self.quantity_input.clear()  # âœ… ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            else:
                QMessageBox.warning(self, "ì˜¤ë¥˜", "í•´ë‹¹ ë°”ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")

        except Exception as e:
            QMessageBox.critical(self, "ì—ëŸ¬ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{str(e)}")




    def export_to_csv(self):
        try:
            filename, _ = QFileDialog.getSaveFileName(self, "Save CSV", "", "CSV Files (*.csv)")
            if filename:
                success = database.export_inventory_to_csv(filename)  # âœ… í•¨ìˆ˜ í˜¸ì¶œ
            
                if success:
                    QMessageBox.information(self, "Success", "CSV file has been successfully exported!")
                else:
                    QMessageBox.warning(self, "Error", "Failed to export CSV file!")

        except Exception as e:
            QMessageBox.critical(self, "Critical Error", f"An unexpected error occurred:\n{str(e)}")



    def load_inventory_data(self):
        products = database.get_all_products()
        self.table.setRowCount(0)
        for product in products:
            row_count = self.table.rowCount()
            self.table.insertRow(row_count)
            for col, data in enumerate(product):
                self.table.setItem(row_count, col, QTableWidgetItem(str(data)))
        self.update_dashboard()



    def update_dashboard(self):
        total_products = database.get_total_product_count()
        self.total_products_label.setText(f"Total Products: {total_products}")
        


    def handle_search(self):
        """ğŸ” ë°”ì½”ë“œ ë˜ëŠ” ì œí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰"""
        search_text = self.search_input.text().strip()

        if not search_text:
            QMessageBox.warning(self, "Warning", "Please enter a barcode or product name.")
            return

        try:
            # ğŸ”¥ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰ ì‹¤í–‰
            results = database.search_product(search_text)

            if results:
                print(f"âœ… [DEBUG] ê²€ìƒ‰ ê²°ê³¼: {results}")  # ê²€ìƒ‰ ê²°ê³¼ ë¡œê·¸ í™•ì¸
                self.display_search_results(results)
            else:
                print("âŒ [DEBUG] ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ")
                QMessageBox.information(self, "Not Found", "No matching products found.")
        except Exception as e:
            print(f"âŒ [ERROR] ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            QMessageBox.critical(self, "Database Error", f"An error occurred while searching:\n{str(e)}")

            
            
            
    def display_search_results(self, results):
        """ğŸ”½ ê²€ìƒ‰ ê²°ê³¼ë¥¼ UI í…Œì´ë¸”ì— í‘œì‹œ"""
        self.results_table.setRowCount(len(results))
        for row, product in enumerate(results):
            for col, value in enumerate(product):
                self.results_table.setItem(row, col, QTableWidgetItem(str(value)))
                
    
    def handle_modify(self):
        """âœï¸ ì„ íƒí•œ ì œí’ˆì„ ìˆ˜ì •"""
        selected_row = self.results_table.currentRow()
        if selected_row < 0:
            return

        barcode = self.results_table.item(selected_row, 0).text()
        name = self.results_table.item(selected_row, 1).text()
        stock = int(self.results_table.item(selected_row, 2).text())
        location = self.results_table.item(selected_row, 3).text()
        equipment = self.results_table.item(selected_row, 4).text()

        self.create_modify_page(barcode, name, stock, location, equipment)  # ìˆ˜ì • í˜ì´ì§€ ì—´ê¸°
        
        
        
    def handle_delete(self):
        """ğŸ—‘ ì„ íƒí•œ ì œí’ˆì„ ì‚­ì œ"""
        selected_row = self.results_table.currentRow()
        if selected_row < 0:
            return

        barcode = self.results_table.item(selected_row, 0).text()

        confirm = QMessageBox.question(self, "Confirm Delete", f"Are you sure you want to delete {barcode}?",
                                        QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if confirm == QMessageBox.Yes:
            database.delete_product(barcode)
            self.results_table.removeRow(selected_row)
            QMessageBox.information(self, "Deleted", "Product deleted successfully.")
            
            
    def create_modify_page(self, barcode, name, stock, location, equipment_group):
        """ğŸ“Œ ìˆ˜ì • í˜ì´ì§€ UI êµ¬ì„±"""
        
        try:
            self.modify_widget = QWidget()
            layout = QVBoxLayout()

            # ğŸ”¹ ë°”ì½”ë“œëŠ” ë³€ê²½ ë¶ˆê°€ (ì½ê¸° ì „ìš©)
            self.barcode_label = QLabel(f"Barcode: {barcode}")

            self.name_input = QLineEdit(self)
            self.name_input.setText(name)

            self.stock_input = QSpinBox(self)
            self.stock_input.setValue(stock)
            self.stock_input.setMinimum(0)

            self.location_input = QLineEdit(self)
            self.location_input.setText(location)

            self.equipment_input = QLineEdit(self)
            self.equipment_input.setText(equipment_group)

            # ğŸ’¾ ì €ì¥ ë²„íŠ¼
            self.save_button = QPushButton("Save Changes")
            self.save_button.clicked.connect(lambda: self.handle_save(barcode))
            
            # ğŸ”™ ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ (ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€)
            self.back_button = QPushButton("Back to Dashboard")
            self.back_button.clicked.connect(self.return_to_dashboard)

            layout.addWidget(self.barcode_label)
            layout.addWidget(QLabel("Product Name:"))
            layout.addWidget(self.name_input)
            layout.addWidget(QLabel("Stock:"))
            layout.addWidget(self.stock_input)
            layout.addWidget(QLabel("Location:"))
            layout.addWidget(self.location_input)
            layout.addWidget(QLabel("Equipment Group:"))
            layout.addWidget(self.equipment_input)
            layout.addWidget(self.save_button)

            self.modify_widget.setLayout(layout)
            self.main_layout.addWidget(self.modify_widget)
            

        except Exception as e:
            print(f"âŒ [ERROR] create_modify_page ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            QMessageBox.critical(self, "Error", f"An unexpected error occurred:\n{str(e)}")
        
        
        
        
    def handle_save(self, barcode):
        """âœ… ì…ë ¥ëœ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥"""
        new_name = self.name_input.text().strip()
        new_stock = self.stock_input.value()
        new_location = self.location_input.text().strip()
        new_equipment = self.equipment_input.text().strip()

        if not new_name or not new_location or not new_equipment:
            QMessageBox.warning(self, "Warning", "All fields must be filled out.")
            return
        
        # ğŸ”¥ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤í–‰
        database.modify_product(barcode, new_name, new_stock, new_location, new_equipment)

        QMessageBox.information(self, "Success", "Product details updated successfully.")

        # ğŸ”„ ìˆ˜ì • í›„ ë‹¤ì‹œ ìˆ˜ì •/ì‚­ì œ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
        self.return_to_dashboard()
        
        
        
        
    def toggle_buttons(self):
        """âœ”ï¸ í…Œì´ë¸”ì—ì„œ í–‰ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ë²„íŠ¼ í™œì„±í™”"""
        selected = self.results_table.selectionModel().hasSelection()
        self.modify_button.setEnabled(selected)
        self.delete_button.setEnabled(selected)





    def return_to_dashboard(self):
        """ğŸ“Œ ìˆ˜ì • í˜ì´ì§€ì—ì„œ ê¸°ì¡´ UI(ëŒ€ì‹œë³´ë“œ/ì¸ë²¤í† ë¦¬)ë¡œ ë³µê·€"""
        try:
            if hasattr(self, "modify_widget"):
                self.modify_widget.setHidden(True)  # âœ… ìˆ˜ì • í˜ì´ì§€ ìˆ¨ê¸°ê¸° (ì œê±° X)
                self.main_layout.removeWidget(self.modify_widget)
                self.modify_widget.deleteLater()
                self.modify_widget = None
            
            
            self.refresh_dashboard_inventory()  # âœ… ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            print("âœ… [SUCCESS] ìˆ˜ì • í›„ ê¸°ì¡´ UIë¡œ ë³µê·€ ì™„ë£Œ.")

        except Exception as e:
            print(f"âŒ [ERROR] return_to_dashboard ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            QMessageBox.critical(self, "Error", f"An error occurred while returning to the previous page:\n{str(e)}")



    def refresh_dashboard_inventory(self):
        """ğŸ”„ ìˆ˜ì •ëœ ë°ì´í„°ë¥¼ ë°˜ì˜í•˜ì—¬ ëŒ€ì‹œë³´ë“œ ë° ì¸ë²¤í† ë¦¬ UI ìƒˆë¡œê³ ì¹¨"""
        try:
            self.table.setRowCount(0)  # ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
            self.inventory_table.setRowCount(0)

            # ğŸ”¥ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            data = database.get_all_products()

            for row_idx, row_data in enumerate(data):
                    # ğŸ“Š ëŒ€ì‹œë³´ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                self.dashboard_table.insertRow(row_idx)
                for col_idx, value in enumerate(row_data):
                    self.dashboard_table.setItem(row_idx, col_idx, QTableWidgetItem(str(value)))

                # ğŸ“¦ ì¸ë²¤í† ë¦¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                self.inventory_table.insertRow(row_idx)
                for col_idx, value in enumerate(row_data):
                    self.inventory_table.setItem(row_idx, col_idx, QTableWidgetItem(str(value)))

            print("âœ… [SUCCESS] ëŒ€ì‹œë³´ë“œ ë° ì¸ë²¤í† ë¦¬ UIê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")

        except Exception as e:
            print(f"âŒ [ERROR] refresh_dashboard_inventory ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            QMessageBox.critical(self, "Error", f"An error occurred while refreshing data:\n{str(e)}")



        
    def open_modify_delete_page(self):
        """ğŸ”„ ìˆ˜ì •/ì‚­ì œ í˜ì´ì§€ë¥¼ ì—´ê¸° (ì‚¬ì´ë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)"""
        try:
            self.setup_modify_delete()  # ìˆ˜ì •/ì‚­ì œ í˜ì´ì§€ ë¡œë“œ
            print("âœ… [SUCCESS] ìˆ˜ì •/ì‚­ì œ í˜ì´ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")

        except Exception as e:
            print(f"âŒ [ERROR] open_modify_delete_page ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            QMessageBox.critical(self, "Error", f"An error occurred while opening modify/delete page:\n{str(e)}")
            
    




if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = InventoryApp()
    window.show()
    sys.exit(app.exec_())
